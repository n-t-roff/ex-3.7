VERSION=3.7
#
# Ex skeletal makefile for VAX VM/Unix 4.1BSD
#
# NB: This makefile doesn't indicate any dependencies on header files.
#
# Ex is very large - this version will not fit on PDP-11's without overlay
# software.  Things that can be turned off to save
# space include LISPCODE (-l flag, showmatch and lisp options), UCVISUAL
# (visual \ nonsense on upper case only terminals), CHDIR (the undocumented
# chdir command.)  CRYPT includes the code to edit encrypted files (the -x
# option, like ed.)  VMUNIX makes ex considerably larger, raising many limits
# and improving speed and simplicity of maintenance.  It is suitable only
# for a VAX or other large machine, and then probably only in a paged system.
#
# Don't define VFORK unless your system has the VFORK system call,
# which is like fork but the two processes have only one data space until the
# child execs. This speeds up ex by saving the memory copy.
#
# If your system expands tabs to 4 spaces you should -DTABS=4 below
#
PREFIX=	${DESTDIR}/usr/local
BINDIR=	${PREFIX}/bin
LIBDIR=	${PREFIX}/libexec
MANDIR=	${PREFIX}/share/man
SHAREDIR=${PREFIX}/share/ex/${VERSION}
PRESERVEDIR=/var/preserve
#
# Either none or both of the next two lines needs to be uncommented
#
#D_SBRK=	-DUNIX_SBRK
#MALLOC_O=mapmalloc.o
#
CTAGS=	${BINDIR}/ctags
DEBUGFLAGS=	-g -O0 -fno-omit-frame-pointer -fno-optimize-sibling-calls \
	-Wall -Wextra \
	-fsanitize=undefined -fsanitize=integer -fsanitize=address
NONDEBUGFLAGS=	
DEB=	${NONDEBUGFLAGS}	# or ${DEBUGFLAGS} to to debug
OPTIONS=-DLISPCODE -DCHDIR -DUCVISUAL -DVMUNIX -DSTDIO -DUSG3TTY \
	-DTABS=8 ${D_SBRK}
_CFLAGS=${OPTIONS} ${DEB} \
	-DLIBDIR='"${LIBDIR}"' -DVERSION='"${VERSION}"' \
	-DPRESERVEDIR='"${PRESERVEDIR}"'
_LDFLAGS=${DEB} -s
OBJS=	ex.o ex_addr.o ex_cmds.o ex_cmds2.o ex_cmdsub.o \
	ex_data.o ex_extern.o ex_get.o ex_io.o ex_put.o ex_re.o \
	ex_set.o ex_subr.o ex_temp.o ex_tty.o ex_unix.o \
	ex_v.o ex_vadj.o ex_vget.o ex_vmain.o ex_voper.o \
	ex_vops.o ex_vops2.o ex_vops3.o ex_vput.o ex_vwind.o \
	printf.o ${MALLOC_O}
HDRS=	ex.h ex_argv.h ex_re.h ex_temp.h ex_tty.h ex_tune.h ex_vars.h ex_vis.h
SRC1=	ex.c ex_addr.c ex_cmds.c ex_cmds2.c ex_cmdsub.c
SRC2=	ex_data.c ex_get.c ex_io.c ex_put.c ex_re.c
SRC3=	ex_set.c ex_subr.c ex_temp.c ex_tty.c ex_unix.c
SRC4=	ex_v.c ex_vadj.c ex_vget.c ex_vmain.c ex_voper.c
SRC5=	ex_vops.c ex_vops2.c ex_vops3.c ex_vput.c ex_vwind.c
SRC6=	printf.c bcopy.c expreserve.c exrecover.c
MISC=	makefile READ_ME rofix
VGRIND=	csh /usr/ucb/vgrind
VHDR=	"Ex Version ${VERSION}"

.c.o:
	${CC} ${CFLAGS} ${_CFLAGS} -c $<

all:	a.out exrecover expreserve #tags

a.out: ${OBJS}
	${CC} ${LDFLAGS} ${_LDFLAGS} ${OBJS} ${TERMLIB}

tags:	/tmp
	${CTAGS} -w ex.[hc] ex_*.[hc]

${OBJS}: ex_vars.h ex.h

# ex_vars.h: ex_data.c
#	csh makeoptions ${CC} -E ${OPTIONS}

exrecover: exrecover.o
	${CC} ${LDFLAGS} ${_LDFLAGS} exrecover.o ex_extern.o -o exrecover

expreserve: expreserve.o
	${CC} ${LDFLAGS} ${_LDFLAGS} expreserve.o -o expreserve

clean:
#	If we dont have ex we cant make it so dont rm ex_vars.h
	-rm -f a.out exrecover expreserve strings core errs trace
	-rm -f *.o x*.[cs]

distclean: clean
	rm -f Makefile config.log

install: ${BINDIR} ${LIBDIR} ${MANDIR}/man1 ${SHAREDIR} ${PRESERVEDIR}
	install a.out ${BINDIR}/ex
	for i in vi view edit; do \
		ln -sf ${BINDIR}/ex ${BINDIR}/$$i; \
	done
	for i in ex vi; do \
		install -m 644 $$i.1 ${MANDIR}/man1/; \
	done
	ln -sf ${MANDIR}/man1/ex.1 ${MANDIR}/man1/edit.1
	ln -sf ${MANDIR}/man1/vi.1 ${MANDIR}/man1/view.1
	for i in recover preserve; do \
		install ex$$i ${LIBDIR}/ex${VERSION}$$i; \
	done
	install -m 644 doc/*.pdf ${SHAREDIR}/

uninstall:
	for i in ex vi view edit; do \
		rm -f ${BINDIR}/$$i; \
		rm -f ${MANDIR}/man1/$$i.1; \
	done
	for i in recover preserve; do \
		rm -f ${LIBDIR}/ex${VERSION}$$i; \
	done
	rm -rf ${SHAREDIR}

${BINDIR} ${LIBDIR} ${MANDIR}/man1 ${SHAREDIR}:
	mkdir -p $@

${PRESERVEDIR}:
	mkdir -p $@
	chmod 1777 $@

lint:
	lint ${CFLAGS} ex.c ex_?*.c
	lint ${CFLAGS} -u exrecover.c
	lint ${CFLAGS} expreserve.c

vgrind:
	tee index < /dev/null
	${VGRIND} -h ${VHDR} ${HDRS}
	${VGRIND} -h ${VHDR} ${SRC1}
	${VGRIND} -h ${VHDR} ${SRC2}
	${VGRIND} -h ${VHDR} ${SRC3}
	${VGRIND} -h ${VHDR} ${SRC4}
	${VGRIND} -h ${VHDR} ${SRC5}
	${VGRIND} -h ${VHDR} ${SRC6}
	${VGRIND} -n -h ${VHDR} ${MISC}
	${VGRIND} -i -h ${VHDR} index
